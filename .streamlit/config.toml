import streamlit as st
import pandas as pd
import os

# Importa as fun√ß√µes de valida√ß√£o
from validador_de_parceiro import validar_parceiros
from validador_de_produto import validar_produtos
from validador_de_estoque import validar_estoque

# --- CONFIGURA√á√ÉO DA P√ÅGINA ---
st.set_page_config(
    page_title="Validador ERP",
    page_icon="ü§ñ",
    layout="wide"
)

# --- CONSTANTES ---
TEMP_PARCEIRO = "temp_parceiros.csv"
TEMP_PRODUTO = "temp_produtos.csv"
TEMP_ESTOQUE = "temp_estoque.csv"
TEMP_MESTRE_PRODUTO = "mestre_produtos.csv"

# --- GERENCIAMENTO DE ESTADO (MEM√ìRIA DO CLICK) ---
# Isso serve para o Streamlit lembrar qual aba est√° aberta
if 'pagina_atual' not in st.session_state:
    st.session_state['pagina_atual'] = 'home'

def set_pagina(nome_pagina):
    st.session_state['pagina_atual'] = nome_pagina

# --- FUN√á√ÉO DE RELAT√ìRIO ---
def exibir_relatorio_erros(erros):
    if erros is None:
        st.error("‚ùå A valida√ß√£o falhou e n√£o p√¥de ser conclu√≠da.")
    elif not erros:
        st.success("‚úÖ SUCESSO! Nenhum erro encontrado. Planilha pronta para importa√ß√£o.")
        st.balloons() # Efeito visual de sucesso
    else:
        st.error(f"‚ùå Foram encontrados {len(erros)} erros.")
        df_erros = pd.DataFrame(erros)
        # Exibe a tabela ocupando a largura total
        st.dataframe(
            df_erros, 
            use_container_width=True,
            hide_index=True,
            column_config={
                "linha": st.column_config.NumberColumn("Linha", format="%d"),
                "coluna": "Nome da Coluna",
                "valor_encontrado": "Valor Inv√°lido",
                "erro": "Descri√ß√£o do Erro"
            }
        )

# --- CABE√áALHO E LOGO ---
col_logo, col_titulo = st.columns([1, 5])

with col_logo:
    # Tenta carregar a logo se ela existir
    try:
        st.image("logo.png", width=150)
    except:
        st.warning("Logo n√£o encontrada")

with col_titulo:
    st.title("Agente Validador de ERP")
    st.markdown("##### Selecione abaixo qual tipo de planilha voc√™ deseja validar")

st.divider() # Linha divis√≥ria visual

# --- BOT√ïES DE NAVEGA√á√ÉO (LAYOUT DE 3 COLUNAS) ---
col1, col2, col3 = st.columns(3)

# Bot√£o 1: Parceiros
with col1:
    # Se a p√°gina atual for parceiros, destacamos o bot√£o (opcional, visualmente o Streamlit padr√£o j√° ajuda)
    if st.button("üë• Validar Parceiros", use_container_width=True):
        set_pagina('parceiros')

# Bot√£o 2: Produtos
with col2:
    if st.button("üì¶ Validar Produtos", use_container_width=True):
        set_pagina('produtos')

# Bot√£o 3: Estoque
with col3:
    if st.button("üè≠ Validar Estoque", use_container_width=True):
        set_pagina('estoque')

st.divider()

# --- CONTE√öDO DIN√ÇMICO ---

if st.session_state['pagina_atual'] == 'home':
    st.info("üëà Clique em uma das op√ß√µes acima para come√ßar.")

# === P√ÅGINA PARCEIROS ===
elif st.session_state['pagina_atual'] == 'parceiros':
    st.header("Valida√ß√£o de Parceiros")
    arquivo_upado = st.file_uploader("Fa√ßa o upload do `parceiros.csv`", type=["csv"])
    
    if arquivo_upado and st.button("Iniciar Valida√ß√£o", type="primary"):
        with open(TEMP_PARCEIRO, "wb") as f:
            f.write(arquivo_upado.getbuffer())
        
        with st.spinner("Analisando regras de neg√≥cio..."):
            erros = validar_parceiros(TEMP_PARCEIRO)
        
        exibir_relatorio_erros(erros)
        if os.path.exists(TEMP_PARCEIRO): os.remove(TEMP_PARCEIRO)

# === P√ÅGINA PRODUTOS ===
elif st.session_state['pagina_atual'] == 'produtos':
    st.header("Valida√ß√£o de Produtos")
    arquivo_upado = st.file_uploader("Fa√ßa o upload do `produtos.csv`", type=["csv"])
    
    if arquivo_upado and st.button("Iniciar Valida√ß√£o", type="primary"):
        with open(TEMP_PRODUTO, "wb") as f:
            f.write(arquivo_upado.getbuffer())
            
        with st.spinner("Analisando NCMs, unidades e regras..."):
            erros = validar_produtos(TEMP_PRODUTO)
            
        exibir_relatorio_erros(erros)
        if os.path.exists(TEMP_PRODUTO): os.remove(TEMP_PRODUTO)

# === P√ÅGINA ESTOQUE ===
elif st.session_state['pagina_atual'] == 'estoque':
    st.header("Valida√ß√£o de Estoque")
    st.warning("‚ö†Ô∏è Necess√°rio arquivo Mestre de Produtos exportado do ERP.")
    
    col_a, col_b = st.columns(2)
    with col_a:
        arquivo_estoque = st.file_uploader("1. Planilha de Estoque (`estoque.csv`)", type=["csv"])
    with col_b:
        arquivo_mestre = st.file_uploader("2. Mestre de Produtos (`mestre_produtos.csv`)", type=["csv"])

    if arquivo_estoque and arquivo_mestre and st.button("Iniciar Valida√ß√£o Cruzada", type="primary"):
        with open(TEMP_ESTOQUE, "wb") as f: f.write(arquivo_estoque.getbuffer())
        with open(TEMP_MESTRE_PRODUTO, "wb") as f: f.write(arquivo_mestre.getbuffer())
        
        with st.spinner("Cruzando dados com o mestre..."):
            erros = validar_estoque(TEMP_ESTOQUE)
            
        exibir_relatorio_erros(erros)
        
        # Limpeza
        if os.path.exists(TEMP_ESTOQUE): os.remove(TEMP_ESTOQUE)
        if os.path.exists(TEMP_MESTRE_PRODUTO): os.remove(TEMP_MESTRE_PRODUTO)